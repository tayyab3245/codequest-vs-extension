<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'none'; img-src ${cspSource} data:; style-src ${cspSource}; script-src 'nonce-${nonce}';">
  <title>CodeQuest Dashboard</title>
  <link rel="stylesheet" href="${cssUri}">
</head>
<body>
  <div class="header">
    <h1>CodeQuest Coach</h1>
    <span id="installedBadge" class="badge">Loading...</span>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Workspace</h2>
      <div class="workspace-info">
        <div>Root folder:</div>
        <div id="workspacePath" class="workspace-path">No folder open</div>
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div id="problemCount" class="stat-value">0</div>
          <div class="stat-label">Problems found</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Current Problem</h2>
      <div id="currentProblem">
        <div class="no-problem">No homework.js file open</div>
      </div>
    </div>

    <div class="card">
      <h2>Commands</h2>
      <div class="command-grid">
        <button id="startSession" class="command-btn">Start Session</button>
        <button id="endSession" class="command-btn">End Session</button>
        <button id="markSolved" class="command-btn">Mark Solved</button>
        <button id="importLegacy" class="command-btn">Import Legacy</button>
      </div>
      <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>
  </div>

  <script nonce="${nonce}">
    const vscode = acquireVsCodeApi();

    // State management
    let state = {
      workspacePath: 'No folder open',
      problemCount: 0,
      currentProblem: null,
      installedAt: null
    };

    // UI update functions
    function updateUI() {
      document.getElementById('workspacePath').textContent = state.workspacePath;
      document.getElementById('problemCount').textContent = state.problemCount.toString();
      
      if (state.installedAt) {
        const date = new Date(state.installedAt).toLocaleDateString();
        document.getElementById('installedBadge').textContent = `Installed: ${date}`;
      }

      updateCurrentProblem();
    }

    function updateCurrentProblem() {
      const container = document.getElementById('currentProblem');
      
      if (!state.currentProblem) {
        container.innerHTML = '<div class="no-problem">No homework.js file open</div>';
        return;
      }

      const p = state.currentProblem;
      const difficultyClass = `difficulty-${p.difficulty.toLowerCase()}`;
      
      container.innerHTML = `
        <div class="problem-details">
          <div class="problem-row">
            <span class="problem-label">Pattern:</span>
            <span class="problem-value">${p.pattern}</span>
          </div>
          <div class="problem-row">
            <span class="problem-label">Problem #:</span>
            <span class="problem-value">${p.number}</span>
          </div>
          <div class="problem-row">
            <span class="problem-label">Name:</span>
            <span class="problem-value">${p.name}</span>
          </div>
          <div class="problem-row">
            <span class="problem-label">Date:</span>
            <span class="problem-value">${p.date}</span>
          </div>
          <div class="problem-row">
            <span class="problem-label">Difficulty:</span>
            <span class="problem-value ${difficultyClass}">${p.difficulty}</span>
          </div>
        </div>
      `;
    }

    function showMessage(text, duration = 3000) {
      const el = document.getElementById('statusMessage');
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(() => {
        el.style.display = 'none';
      }, duration);
    }

    // Message handling
    window.addEventListener('message', event => {
      const message = event.data;
      
      switch (message.type) {
        case 'updateState':
          state = { ...state, ...message.data };
          updateUI();
          break;
        case 'commandResult':
          showMessage(message.message);
          break;
      }
    });

    // Command handlers
    document.getElementById('startSession').addEventListener('click', () => {
      vscode.postMessage({ command: 'codequest.startSession' });
    });

    document.getElementById('endSession').addEventListener('click', () => {
      vscode.postMessage({ command: 'codequest.endSession' });
    });

    document.getElementById('markSolved').addEventListener('click', () => {
      vscode.postMessage({ command: 'codequest.markSolved' });
    });

    document.getElementById('importLegacy').addEventListener('click', () => {
      vscode.postMessage({ command: 'codequest.importLegacy' });
    });

    // Request initial state
    vscode.postMessage({ command: 'getInitialState' });
  </script>
</body>
</html>
